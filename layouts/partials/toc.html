{{/* Right-hand Table of Contents (regex-based, styled like original) */}}

{{- $toc := .Params.toc | default true -}}
{{- $onThisPage := (T "onThisPage") | default "On this page" -}}
{{- $tags := (T "tags") | default "Tags" -}}
{{- $editThisPage := (T "editThisPage") | default "Edit this page" -}}
{{- $backToTop := (T "backToTop") | default "Scroll to top" -}}

{{- $startLevel := 2 }}
{{- $endLevel := 4 }}
{{- $minNumHeadings := 2 }}

{{- /* Collect headings with regex */ -}}
{{- $headings := slice }}
{{- range findRE `(?is)<h\d.*?</h\d>` .Content }}
  {{- $level := substr . 2 1 | int }}
  {{- if and (ge $level $startLevel) (le $level $endLevel) }}
    {{- $text := replaceRE `(?is)<h\d.*?>(.+?)</h\d>` "$1" . | plainify | htmlUnescape }}
    {{- $id := "" }}
    {{- if findRE `\s+id=` . }}
      {{- $id = replaceRE `(?is).+?\s+id=(?:\x22|\x27)?(.*?)(?:\x22|\x27)?[\s>].+` "$1" . }}
    {{- end }}
    {{- $headings = $headings | append (dict "id" $id "level" $level "text" $text) }}
  {{- end }}
{{- end }}

{{/* Recursive renderer for nested headings, with original CSS */}}
{{- define "render-headings" -}}
  {{- $headings := .headings }}
  {{- $parentLevel := .parentLevel }}
  <ul>
    {{- range $i, $h := $headings }}
      {{- $next := index $headings (add $i 1) | default dict }}
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        {{- $padding := mul (sub $h.level $parentLevel) 4 -}}
        {{- $class := cond (eq $h.level $parentLevel) "hx:font-medium" (printf "hx:ltr:pl-%d hx:rtl:pr-%d" $padding $padding) -}}
        <a
          href="#{{ $h.id }}"
          class="{{ $class }} hx-font-semibold hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words"
        >
          {{ $h.text }}
        </a>

        {{- if and $next.id (gt $next.level $h.level) }}
          {{- $subs := slice }}
          {{- range $j := seq (add $i 1) (sub (len $headings) 1) }}
            {{- $nh := index $headings $j }}
            {{- if eq $nh.level $h.level }}{{ break }}{{ end }}
            {{- $subs = $subs | append $nh }}
          {{- end }}
          {{- if gt (len $subs) 0 }}
            {{ template "render-headings" (dict "headings" $subs "parentLevel" $h.level) }}
          {{- end }}
        {{- end }}
      </li>
    {{- end }}
  </ul>
{{- end }}

{{- if and $toc (ge (len $headings) $minNumHeadings) }}
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
  <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4">
    <p class="hx-mb-4 hx-font-semibold hx-tracking-tight">{{ $onThisPage }}</p>

    {{ template "render-headings" (dict "headings" $headings "parentLevel" $startLevel) }}

    {{- $borderClass := "hx:mt-8 hx:border-t hx:bg-white hx:pt-8 hx:shadow-[0_-12px_16px_white] hx:dark:bg-dark hx:dark:shadow-[0_-12px_16px_#111]" -}}
    <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400">

      {{- if and site.Params.toc.displayTags .Params.tags -}}
        <div class="hx:flex hx:items-start hx:gap-x-2 hx:font-medium hx:text-xs">
          <div class="hx:text-gray-500 hx:dark:text-gray-400 hx:contrast-more:text-gray-800 hx:contrast-more:dark:text-gray-50">{{ $tags }}</div>
          <div class="hx:flex hx:flex-wrap hx:gap-y-1">
            {{ partial "tags.html" (dict "context" .) }}
          </div>
        </div>
      {{- end }}

      {{- if site.Params.editURL.enable -}}
        {{- $editURL := site.Params.editURL.base | default "" -}}
        {{- with .Params.editURL -}}
          {{- $editURL = . -}}
        {{- else -}}
          {{- with .File -}}
            {{- $sourceDir := replace (strings.TrimPrefix .FileInfo.Meta.BaseDir .FileInfo.Meta.SourceRoot) "\\" "/" -}}
            {{- $sourceDir = strings.TrimPrefix "/content" $sourceDir -}}
            {{- $path := replace .Path "\\" "/" -}}
            {{- $editURL = urls.JoinPath $editURL $sourceDir $path -}}
          {{- end }}
        {{- end }}
        <a class="hx:text-xs hx:font-medium hx:text-gray-500 hx:hover:text-gray-900 hx:dark:text-gray-400 hx:dark:hover:text-gray-100 hx:contrast-more:text-gray-800 hx:contrast-more:dark:text-gray-50" href="{{ $editURL }}" target="_blank" rel="noreferrer">{{ $editThisPage }}</a>
      {{- end }}
      <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
        <span>{{ $backToTop }}</span>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
        </svg>
      </button>
    </div>
  </div>
</nav>
{{- end }}
